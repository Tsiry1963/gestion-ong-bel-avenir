<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEL AVENIR - Gestion Sociale Complète</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');
        :root { --ong-orange: #ff8c00; --ong-dark: #0f172a; }
        body { font-family: 'Poppins', sans-serif; background: #f8fafc; color: var(--ong-dark); }
        .card { background: white; border-radius: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #f1f5f9; }
        .input-field { border: 1.5px solid #cbd5e1; padding: 0.6rem 1rem; border-radius: 0.75rem; width: 100%; font-size: 0.875rem; }
        .label-text { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.2rem; display: block; }
        .btn-primary { background: var(--ong-orange); color: white; font-weight: 700; border-radius: 0.75rem; transition: 0.3s; cursor: pointer; border: none; }
        .section-pane { display: none; }
        .section-pane.active { display: block; }
        #auth-overlay { position: fixed; inset: 0; background: var(--ong-dark); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .check-group { display: flex; flex-wrap: wrap; gap: 1rem; background: #f1f5f9; padding: 0.75rem; border-radius: 0.75rem; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="bg-white p-10 rounded-[2rem] shadow-2xl w-full max-w-md text-center">
        <h2 class="text-2xl font-black mb-2">ONG BEL AVENIR</h2>
        <p class="text-slate-400 text-sm mb-8">Veuillez vous identifier pour accéder au système</p>
        <div class="space-y-4">
            <input type="email" id="auth-email" placeholder="Email Firebase" class="input-field">
            <input type="password" id="auth-pass" placeholder="Mot de passe" class="input-field">
            <button id="login-btn" class="btn-primary w-full py-4 uppercase text-xs tracking-widest">Entrer</button>
        </div>
        <p id="auth-error" class="text-red-500 text-xs mt-4 hidden"></p>
    </div>
</div>

<nav id="main-nav" class="bg-white border-b sticky top-0 z-50 hidden">
    <div class="container mx-auto px-6 h-20 flex justify-between items-center">
        <div class="flex gap-4">
            <button onclick="showSection('home')" class="font-bold text-slate-600">ACCUEIL</button>
            <button onclick="showSection('form')" class="font-bold text-slate-600">NOUVELLE FICHE</button>
            <button onclick="showSection('list')" class="font-bold text-slate-600">REGISTRE</button>
        </div>
        <button id="logout-btn" class="text-red-500 font-bold text-xs">DÉCONNEXION</button>
    </div>
</nav>

<div class="container mx-auto px-6 py-10">
    <section id="sec-home" class="section-pane active">
        <div class="card p-10 text-center">
            <h1 class="text-5xl font-black mb-4">Système Social <span class="text-orange-500">Expert</span></h1>
            <p class="text-slate-500">Session active pour l'UID : <span id="user-uid" class="font-bold text-orange-600"></span></p>
        </div>
    </section>

    <section id="sec-form" class="section-pane">
        <div class="card p-10 border-t-8 border-orange-500">
            <h2 class="text-2xl font-black mb-8 uppercase">Dossier du Bénéficiaire</h2>
            
            <div class="grid lg:grid-cols-4 gap-8 mb-12">
                <div class="text-center">
                    <img id="preview-photo" src="https://via.placeholder.com/150" class="w-40 h-40 rounded-[2rem] mx-auto object-cover border-4 border-slate-100 shadow-lg mb-4">
                    <input type="file" id="benef-photo" class="hidden" onchange="previewPhoto(this)">
                    <button onclick="document.getElementById('benef-photo').click()" class="text-[10px] font-black text-blue-600 uppercase">Charger Photo ID</button>
                    <input type="text" id="f-id" placeholder="ID (ex: BA-100)" class="input-field mt-4 text-center font-bold text-orange-600">
                </div>
                <div class="lg:col-span-3 grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-2"><label class="label-text">Nom et Prénom</label><input type="text" id="f-nom" class="input-field"></div>
                    <div><label class="label-text">Sexe</label><select id="f-sexe" class="input-field"><option>Masculin</option><option>Féminin</option></select></div>
                    <div><label class="label-text">Date & Lieu de naissance (Vers)</label><input type="text" id="f-dob" class="input-field"></div>
                    <div><label class="label-text">Âge</label><input type="number" id="f-age" class="input-field"></div>
                    <div class="md:col-span-3">
                        <label class="label-text">Acte de naissance</label>
                        <div class="check-group">
                            <label><input type="radio" name="acte" value="En possède"> En possède</label>
                            <label><input type="radio" name="acte" value="N'en possède pas"> N'en possède pas</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-slate-50 p-8 rounded-3xl mb-12">
                <h3 class="text-orange-600 font-black text-xs uppercase mb-6">Situation Scolaire</h3>
                <div class="grid md:grid-cols-4 gap-4 mb-6">
                    <input type="text" id="f-last-niv" placeholder="Dernier Niveau" class="input-field">
                    <input type="text" id="f-last-moy" placeholder="Moyenne Générale" class="input-field">
                    <input type="text" id="f-insc-site" placeholder="Site d'inscription" class="input-field">
                    <select id="f-bull" class="input-field"><option>Bulletin Oui</option><option>Bulletin Non</option></select>
                </div>
                
                <div class="bg-white p-6 rounded-2xl border mb-6">
                    <table class="w-full text-xs">
                        <thead><tr class="text-slate-400 font-black text-left"><th>Matière</th><th>Coef</th><th>Note /20</th><th>Obs</th></tr></thead>
                        <tbody id="notes-body">
                            <tr>
                                <td><input type="text" class="input-field n-mat"></td>
                                <td><input type="number" class="input-field n-coef" oninput="calcMoy()"></td>
                                <td><input type="number" class="input-field n-val" oninput="calcMoy()"></td>
                                <td><input type="text" class="input-field n-obs"></td>
                            </tr>
                        </tbody>
                    </table>
                    <button onclick="addNoteRow()" class="mt-4 text-[10px] font-black text-blue-600 uppercase">+ Ajouter une matière</button>
                    <div class="mt-4 text-right font-black">Moyenne : <span id="auto-moy">0.00</span> / 20</div>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-8 mb-12">
                <div class="p-6 border rounded-3xl">
                    <h3 class="text-xs font-black uppercase mb-4">Situation Familiale</h3>
                    <input type="text" id="f-tut-nom" placeholder="Nom du tuteur" class="input-field mb-2">
                    <input type="text" id="f-tut-contact" placeholder="Contact Tuteur" class="input-field mb-2">
                    <input type="text" id="f-tut-prof" placeholder="Profession Tuteur" class="input-field">
                </div>
                <div class="p-6 border rounded-3xl">
                    <h3 class="text-xs font-black uppercase mb-4">Habitat & Maison</h3>
                    <input type="text" id="f-maison-etat" placeholder="État de la maison" class="input-field mb-2">
                    <input type="text" id="f-maison-nat" placeholder="Nature (Matériaux)" class="input-field mb-2">
                    <textarea id="f-obs" placeholder="Autres observations..." class="input-field h-20"></textarea>
                </div>
            </div>

            <button onclick="saveData()" class="btn-primary w-full py-5 uppercase shadow-xl">Enregistrer le dossier complet</button>
        </div>
    </section>

    <section id="sec-list" class="section-pane">
        <h2 class="text-3xl font-black mb-8 uppercase">Registre des Bénéficiaires</h2>
        <div class="card overflow-hidden">
            <table class="w-full text-left text-sm">
                <thead class="bg-slate-50 border-b text-[10px] font-black text-slate-400">
                    <tr><th class="p-5">Bénéficiaire</th><th>Identifiant</th><th>Sexe</th><th class="text-right p-5">Actions</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </section>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDKNy6B4aifDrVDsglGhvU_eCMZOZF6q8g",
        authDomain: "bel-avenir-social-db-878f7.firebaseapp.com",
        databaseURL: "https://bel-avenir-social-db-878f7-default-rtdb.firebaseio.com",
        projectId: "bel-avenir-social-db-878f7",
        storageBucket: "bel-avenir-social-db-878f7.firebasestorage.app",
        messagingSenderId: "483959875408",
        appId: "1:483959875408:web:e7708cd4100a9fe9752e55",
        measurementId: "G-YMWKP5DBKC"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let photoData = "";

    // GESTION CONNEXION
    document.getElementById('login-btn').addEventListener('click', async () => {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (e) {
            document.getElementById('auth-error').innerText = "Accès refusé.";
            document.getElementById('auth-error').classList.remove('hidden');
        }
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('main-nav').classList.remove('hidden');
            document.getElementById('user-uid').innerText = user.uid;
            loadData();
        } else {
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    });

    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

    // FONCTIONS FORMULAIRE
    window.showSection = (id) => {
        document.querySelectorAll('.section-pane').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-'+id).classList.add('active');
    };

    window.previewPhoto = (input) => {
        const reader = new FileReader();
        reader.onload = (e) => { photoData = e.target.result; document.getElementById('preview-photo').src = e.target.result; };
        reader.readAsDataURL(input.files[0]);
    };

    window.addNoteRow = () => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input type="text" class="input-field n-mat"></td><td><input type="number" class="input-field n-coef" oninput="calcMoy()"></td><td><input type="number" class="input-field n-val" oninput="calcMoy()"></td><td><input type="text" class="input-field n-obs"></td>`;
        document.getElementById('notes-body').appendChild(tr);
    };

    window.calcMoy = () => {
        let pts = 0, coefs = 0;
        document.querySelectorAll('#notes-body tr').forEach(tr => {
            const c = parseFloat(tr.querySelector('.n-coef').value) || 0;
            const v = parseFloat(tr.querySelector('.n-val').value) || 0;
            pts += (v * c); coefs += c;
        });
        const m = coefs > 0 ? (pts / coefs).toFixed(2) : "0.00";
        document.getElementById('auto-moy').innerText = m;
        return m;
    };

    window.saveData = () => {
        const payload = {
            id: document.getElementById('f-id').value,
            nom: document.getElementById('f-nom').value,
            sexe: document.getElementById('f-sexe').value,
            photo: photoData,
            scol: { niv: document.getElementById('f-last-niv').value, moy: document.getElementById('auto-moy').innerText, site: document.getElementById('f-insc-site').value },
            famille: { tuteur: document.getElementById('f-tut-nom').value, contact: document.getElementById('f-tut-contact').value },
            habitat: { etat: document.getElementById('f-maison-etat').value, nature: document.getElementById('f-maison-nat').value }
        };
        push(ref(db, 'beneficiaires'), payload).then(() => { alert("Dossier sauvegardé !"); showSection('list'); });
    };

    function loadData() {
        onValue(ref(db, 'beneficiaires'), (snap) => {
            const data = snap.val();
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";
            if(data) {
                Object.keys(data).forEach(k => {
                    const b = data[k];
                    tbody.innerHTML += `<tr class="border-b"><td class="p-4 flex items-center gap-2"><img src="${b.photo}" class="w-10 h-10 rounded-full object-cover"><b>${b.nom}</b></td><td>${b.id}</td><td>${b.sexe}</td><td class="text-right p-4"><button onclick="deleteB('${k}')" class="text-red-400"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            }
        });
    }

    window.deleteB = (key) => { if(confirm("Supprimer ce dossier ?")) remove(ref(db, 'beneficiaires/'+key)); };

</script>
</body>
</html>
